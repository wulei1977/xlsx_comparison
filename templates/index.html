<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelæ–‡ä»¶å¯¹æ¯”å·¥å…·</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .upload-section { display: flex; gap: 20px; margin-bottom: 20px; }
        .file-box { flex: 1; background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .file-box h3 { margin-bottom: 15px; color: #555; }
        .upload-area { border: 2px dashed #ccc; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { border-color: #007bff; background: #f8f9fa; }
        .upload-area.uploaded { border-color: #28a745; background: #d4edda; }
        .upload-area input { display: none; }
        .file-name { margin-top: 10px; font-size: 14px; color: #666; word-break: break-all; }
        .config-row { margin-top: 15px; }
        .config-row label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .config-row select, .config-row input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .keys-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .key-tag { background: #007bff; color: #fff; padding: 4px 10px; border-radius: 4px; font-size: 13px; display: flex; align-items: center; gap: 5px; }
        .key-tag .remove { cursor: pointer; font-weight: bold; }
        .compare-btn { display: block; width: 100%; padding: 15px; background: #007bff; color: #fff; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 20px 0; transition: background 0.3s; }
        .compare-btn:hover { background: #0056b3; }
        .compare-btn:disabled { background: #ccc; cursor: not-allowed; }
        .result-section { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .result-header h3 { color: #555; }
        .download-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .download-btn { padding: 8px 16px; background: #28a745; color: #fff; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; }
        .download-btn:hover { opacity: 0.9; }
        .result-content { background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 13px; white-space: pre-wrap; max-height: 600px; overflow-y: auto; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Excelæ–‡ä»¶å¯¹æ¯”å·¥å…·</h1>
        
        <div class="upload-section">
            <div class="file-box">
                <h3>æ–‡ä»¶1</h3>
                <div class="upload-area" id="upload1" onclick="document.getElementById('file1').click()">
                    <input type="file" id="file1" accept=".xlsx,.xls" onchange="uploadFile(1)">
                    <div>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Excelæ–‡ä»¶</div>
                    <div class="file-name" id="filename1"></div>
                </div>
                <div class="config-row">
                    <label>é€‰æ‹©Worksheet</label>
                    <select id="sheet1" onchange="updateColumns(1)"><option value="">è¯·å…ˆä¸Šä¼ æ–‡ä»¶</option></select>
                </div>
                <div class="config-row">
                    <label>é€‰æ‹©è¡Œé”®åˆ—ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <select id="colSelect1" onchange="addKey(1)"><option value="">é€‰æ‹©åˆ—æ·»åŠ ä¸ºé”®</option></select>
                    <div class="keys-container" id="keys1"></div>
                </div>
            </div>
            
            <div class="file-box">
                <h3>æ–‡ä»¶2</h3>
                <div class="upload-area" id="upload2" onclick="document.getElementById('file2').click()">
                    <input type="file" id="file2" accept=".xlsx,.xls" onchange="uploadFile(2)">
                    <div>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Excelæ–‡ä»¶</div>
                    <div class="file-name" id="filename2"></div>
                </div>
                <div class="config-row">
                    <label>é€‰æ‹©Worksheet</label>
                    <select id="sheet2" onchange="updateColumns(2)"><option value="">è¯·å…ˆä¸Šä¼ æ–‡ä»¶</option></select>
                </div>
                <div class="config-row">
                    <label>é€‰æ‹©è¡Œé”®åˆ—ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <select id="colSelect2" onchange="addKey(2)"><option value="">é€‰æ‹©åˆ—æ·»åŠ ä¸ºé”®</option></select>
                    <div class="keys-container" id="keys2"></div>
                </div>
            </div>
        </div>
        
        <button class="compare-btn" id="compareBtn" onclick="compare()" disabled>å¼€å§‹å¯¹æ¯”</button>
        
        <div class="result-section hidden" id="resultSection">
            <div class="result-header">
                <h3>å¯¹æ¯”ç»“æœ</h3>
                <div style="font-size: 0.85em;">
                    <font style="font-size: 1.5em;">ğŸ“ƒ å·®å¼‚æ ‡æ³¨è¯´æ˜</font><br>
                    <li>ğŸŸ© <font style="background-color: green;">ç»¿è‰²èƒŒæ™¯</font>ï¼šä»…åœ¨å½“å‰æ–‡ä»¶ä¸­å­˜åœ¨çš„è¡Œ</li>
                    <li>ğŸŸ¨ <font style="background-color: yellow; color: red;">é»„è‰²èƒŒæ™¯ + çº¢è‰²å­—ä½“</font>ï¼šä¸å¦ä¸€æ–‡ä»¶æœ‰å·®å¼‚çš„å•å…ƒæ ¼</li>
                    <li>ğŸ–± é¼ æ ‡æ‚¬åœå•å…ƒæ ¼å¯æŸ¥çœ‹æ‰¹æ³¨ğŸ’¬ï¼Œæ˜¾ç¤ºå¯¹æ¯”æ–‡ä»¶ä¸­çš„å¯¹åº”å€¼</li>
                </div>
                <div class="download-buttons">
                    <a class="download-btn hidden" id="downloadBtn" href="#">ä¸‹è½½å¯¹æ¯”æŠ¥å‘Š</a>
                    <a class="download-btn hidden" id="downloadMarked1Btn" href="#" style="background:#17a2b8;">ä¸‹è½½æ ‡æ³¨æ–‡ä»¶1</a>
                    <a class="download-btn hidden" id="downloadMarked2Btn" href="#" style="background:#17a2b8;">ä¸‹è½½æ ‡æ³¨æ–‡ä»¶2</a>
                </div>
            </div>
            <div class="result-content" id="resultContent"></div>
        </div>
    </div>

    <script>
        const BASE_PATH = '{{ base_path|default("", true) }}';
        console.log('BASE_PATH:', BASE_PATH);
        const fileData = { 1: null, 2: null };
        const selectedKeys = { 1: [], 2: [] };

        function apiUrl(path) {
            const url = BASE_PATH + path;
            console.log('API URL:', url);
            return url;
        }

        async function uploadFile(num) {
            const fileInput = document.getElementById(`file${num}`);
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            document.getElementById(`filename${num}`).textContent = 'ä¸Šä¼ ä¸­...';

            try {
                const resp = await fetch(apiUrl('/upload'), { method: 'POST', body: formData });
                const data = await resp.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }

                fileData[num] = data;
                document.getElementById(`upload${num}`).classList.add('uploaded');
                document.getElementById(`filename${num}`).textContent = data.original_name;

                // å¡«å……sheeté€‰æ‹©
                const sheetSelect = document.getElementById(`sheet${num}`);
                sheetSelect.innerHTML = Object.keys(data.sheets).map(s => `<option value="${s}">${s}</option>`).join('');
                updateColumns(num);
                checkReady();
            } catch (e) {
                alert('ä¸Šä¼ å¤±è´¥: ' + e.message);
            }
        }

        function updateColumns(num) {
            const data = fileData[num];
            if (!data) return;

            const sheet = document.getElementById(`sheet${num}`).value;
            const columns = data.sheets[sheet] || [];
            const colSelect = document.getElementById(`colSelect${num}`);
            
            colSelect.innerHTML = '<option value="">é€‰æ‹©åˆ—æ·»åŠ ä¸ºé”®</option>' + 
                columns.map(c => `<option value="${c}">${c}</option>`).join('');
            
            selectedKeys[num] = [];
            renderKeys(num);
        }

        function addKey(num) {
            const select = document.getElementById(`colSelect${num}`);
            const col = select.value;
            if (col && !selectedKeys[num].includes(col)) {
                selectedKeys[num].push(col);
                renderKeys(num);
            }
            select.value = '';
            checkReady();
        }

        function removeKey(num, col) {
            selectedKeys[num] = selectedKeys[num].filter(k => k !== col);
            renderKeys(num);
            checkReady();
        }

        function renderKeys(num) {
            const container = document.getElementById(`keys${num}`);
            container.innerHTML = selectedKeys[num].map(k => 
                `<span class="key-tag">${k}<span class="remove" onclick="removeKey(${num}, '${k}')">&times;</span></span>`
            ).join('');
        }

        function checkReady() {
            const ready = fileData[1] && fileData[2] && selectedKeys[1].length > 0 && selectedKeys[2].length > 0;
            document.getElementById('compareBtn').disabled = !ready;
        }

        async function compare() {
            const btn = document.getElementById('compareBtn');
            btn.disabled = true;
            btn.textContent = 'å¯¹æ¯”ä¸­...';

            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');
            resultSection.classList.remove('hidden');
            resultContent.textContent = 'æ­£åœ¨å¯¹æ¯”ï¼Œè¯·ç¨å€™...';

            try {
                const resp = await fetch(apiUrl('/compare'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file1_id: fileData[1].file_id,
                        file2_id: fileData[2].file_id,
                        sheet1: document.getElementById('sheet1').value,
                        sheet2: document.getElementById('sheet2').value,
                        keys: selectedKeys[1]  // ä½¿ç”¨æ–‡ä»¶1çš„é”®åˆ—
                    })
                });
                const data = await resp.json();

                if (data.error) {
                    resultContent.textContent = 'é”™è¯¯: ' + data.error;
                } else {
                    resultContent.textContent = data.result;
                    const downloadBtn = document.getElementById('downloadBtn');
                    downloadBtn.href = apiUrl(`/download/${data.result_id}`);
                    downloadBtn.classList.remove('hidden');
                    
                    // æ˜¾ç¤ºæ ‡æ³¨æ–‡ä»¶ä¸‹è½½æŒ‰é’®
                    if (data.has_marked_files) {
                        const downloadMarked1Btn = document.getElementById('downloadMarked1Btn');
                        const downloadMarked2Btn = document.getElementById('downloadMarked2Btn');
                        downloadMarked1Btn.href = apiUrl(`/download_marked/${data.result_id}/1`);
                        downloadMarked2Btn.href = apiUrl(`/download_marked/${data.result_id}/2`);
                        downloadMarked1Btn.classList.remove('hidden');
                        downloadMarked2Btn.classList.remove('hidden');
                    }
                }
            } catch (e) {
                resultContent.textContent = 'å¯¹æ¯”å¤±è´¥: ' + e.message;
            }

            btn.disabled = false;
            btn.textContent = 'å¼€å§‹å¯¹æ¯”';
        }
    </script>
</body>
</html>
